---
title: misskeyインスタンスを連合せずに建てる
description: 
published: true
date: 2024-05-01T04:44:18.420Z
tags: maintenance, proxy
editor: markdown
dateCreated: 2023-04-07T22:54:24.913Z
---

:warning: この記事はGoogleキャッシュからサルベージしました。(4月以前に投稿された記事です)

# misskeyインスタンスを連合せずに建てる

- misskey v12以降を想定しています。

ステージング環境等インスタンスを連合せずに建てたい用途があります。
しかしmisskeyには連合機能を無効にするオプションはありません。
なので連合せずに立てるには若干Hackyな設定が必要になります。

## 手順

misskeyには大きく分け外部から内部へのnginxを経由したアクセスと、内部から外部への通信があります。
それぞれを制限することにより外部との通信を行えないようにして連合をしないようにします。

- 内部から外部への通信を制限する。
以下のようにmisskeyのconfigファイル(.config/default.yml)を編集して起動します。
proxy行を見つけてコメントアウトを外し、プロキシとして存在しない適当なポート番号を指定します。
当然存在するプロキシを指定してはいけません。
これにより内部から外部への通信が当該プロキシを経由しようとして、結果として失敗します。
ただし外部のインスタンスから内部への通信は拒否されません。
なので検索欄に直接URLを入力して表示する等の操作を行った場合外部のインスタンスに表示されてしまいます。

- 外部から内部への通信を制限する。
以下のようにnginxのディレクティブに記述します。
位置はドメイン設定の後、リバースプロキシをする前あたりがいいでしょう。
UAを見て一般的なブラウザ以外を弾きます。

```
if ( $http_user_agent !~* (firefox|iphone|chrome) ) {
        return 403;
}
(※注意 内容は洗練されていますせん。)
```

## 参考文献

以下の記事を参考にさせていただきました。

[Misskeyでソースを変更せずに連合を完全無効化する方法 - CookieRamen](https://scrapbox.io/cookie-ramen/Misskey%E3%81%A7%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%9B%E3%81%9A%E3%81%AB%E9%80%A3%E5%90%88%E3%82%92%E5%AE%8C%E5%85%A8%E7%84%A1%E5%8A%B9%E5%8C%96%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95)